<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="UTF-8">
    <title>Untitled</title>
    

  </head>
    
  <body>
  <!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pixel Bonfire v6.0 - Desktop Player Edition</title>
    <script src="https://cdn.jsdelivr.net/npm/gif.js@0.2.0/dist/gif.js"></script>
    <style>
        :root { 
            --bg: #000000; 
            --panel-bg: #1d1d1f;
            --text-main: #f5f5f7;
            --text-secondary: #86868b;
            --accent: #0071e3;
            --border-color: rgba(255, 255, 255, 0.1);
            --panel-width: 280px;
            --control-bg: #2c2c2e;
        }

        body.light-mode {
            --bg: #ffffff;
            --panel-bg: #f5f5f7;
            --text-main: #1d1d1f;
            --text-secondary: #6e6e73;
            --accent: #0071e3;
            --border-color: rgba(0, 0, 0, 0.1);
            --control-bg: #e8e8ed;
        }

        body {
            background-color: var(--bg); color: var(--text-main);
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", Helvetica, Arial, sans-serif;
            margin: 0; display: flex; flex-direction: row;
            height: 100vh; overflow: hidden; touch-action: none;
            transition: background-color 0.3s ease;
        }

        /* 桌面端抽屉式侧边栏 */
        #ui-panel {
            width: var(--panel-width);
            min-width: var(--panel-width);
            background: var(--panel-bg);
            border-right: 1px solid var(--border-color);
            padding: 24px 20px;
            display: flex;
            flex-direction: column;
            gap: 14px;
            z-index: 110;
            overflow-y: auto;
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1), margin-left 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }

        #ui-panel.collapsed {
            margin-left: calc(var(--panel-width) * -1);
            transform: translateX(0);
        }

        /* 隐藏/展开 触发器 */
        #ui-toggle {
            position: fixed;
            left: var(--panel-width);
            top: 24px;
            width: 32px;
            height: 32px;
            background: var(--panel-bg);
            border: 1px solid var(--border-color);
            border-left: none;
            border-radius: 0 8px 8px 0;
            color: var(--text-main);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 120;
            transition: left 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 14px;
            box-shadow: 4px 0 10px rgba(0,0,0,0.1);
        }

        #ui-panel.collapsed + #ui-toggle {
            left: 0;
        }

        h3 { margin: 0; font-size: 18px; font-weight: 600; letter-spacing: -0.02em; }

        #main-view {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg);
            overflow: hidden;
            transition: background-color 0.3s ease;
            position: relative;
        }

        .control-group { display: flex; flex-direction: column; gap: 8px; }
        label { font-size: 11px; font-weight: 500; color: var(--text-secondary); text-transform: uppercase; }
        
        #canvas-wrapper { 
            position: relative; 
            line-height: 0;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        canvas { 
            image-rendering: pixelated; 
            cursor: crosshair; 
            background: #000; 
            border-radius: 4px; 
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }

        button {
            background: var(--accent); color: white; border: none;
            padding: 10px; border-radius: 8px; font-size: 12px; font-weight: 500; cursor: pointer;
            transition: opacity 0.2s;
        }
        button:hover { opacity: 0.85; }
        button.secondary { background: var(--control-bg); color: var(--text-main); }

        select {
            background: var(--control-bg); color: var(--text-main);
            border: 1px solid var(--border-color); padding: 8px; border-radius: 8px; font-size: 12px;
            outline: none;
        }

        input[type="color"] {
            -webkit-appearance: none; border: none; width: 100%; height: 32px;
            cursor: pointer; background: none; padding: 0; border-radius: 6px; overflow: hidden;
        }
        input[type="color"]::-webkit-color-swatch-wrapper { padding: 0; }
        input[type="color"]::-webkit-color-swatch { border: 1px solid var(--border-color); border-radius: 6px; }

        input[type="range"] {
            -webkit-appearance: none; width: 100%; height: 4px;
            background: var(--control-bg); border-radius: 2px; accent-color: var(--accent);
        }

        .divider { height: 1px; background: var(--border-color); margin: 4px 0; }
        #status { font-size: 11px; color: var(--text-secondary); text-align: center; margin-top: auto; padding-top: 10px;}
        .val-tag { float: right; color: var(--accent); font-weight: 600; }
    </style>
</head>
<body>

    <div id="ui-panel">
        <h3>Bonfire</h3>
        
        <div class="control-group">
            <label>UI 风格 / UI Theme</label>
            <select id="uiTheme">
                <option value="dark">暗黑 / Dark</option>
                <option value="light">明亮 / Light</option>
            </select>
        </div>

        <div class="divider"></div>

        <div class="control-group">
            <label>调色盘预设 / Color Presets</label>
            <select id="colorPresets">
                <option value="custom">自定义 / Custom</option>
                <option value="classic">经典 / Classic</option>
                <option value="soul">灵魂 / Soul</option>
                <option value="forest">森之火 / Forest</option>
                <option value="cyber">赛博 / Cyberpunk</option>
                <option value="toxic">剧毒 / Toxic</option>
                <option value="void">虚空 / Void</option>
                <option value="sunset">落日 / Sunset</option>
                <option value="ocean">深海 / Ocean</option>
                <option value="gold">黄金 / Gold</option>
                <option value="sakura">樱花 / Sakura</option>
            </select>
        </div>

        <div class="control-group">
            <label>顶部 (余烬) / Top (Ember)</label>
            <input type="color" id="colorTop" value="#ff2200">
        </div>
        <div class="control-group">
            <label>中部 (主体) / Mid (Body)</label>
            <input type="color" id="colorMid" value="#ff8800">
        </div>
        <div class="control-group">
            <label>底部 (高热) / Bottom (Heat)</label>
            <input type="color" id="colorBottom" value="#ffffff">
        </div>

        <button class="secondary" onclick="randomizeFireColors()">随机配色 / Random Colors</button>

        <div class="divider"></div>

        <div class="control-group">
            <label>画布宽度 / Width <span class="val-tag" id="val-width">400</span></label>
            <input type="range" id="canvasWidth" min="200" max="1200" value="400">
        </div>
        <div class="control-group">
            <label>画布高度 / Height <span class="val-tag" id="val-height">500</span></label>
            <input type="range" id="canvasHeight" min="200" max="1200" value="500">
        </div>

        <div class="divider"></div>

        <div class="control-group">
            <label>燃烧速度 / Burn Speed <span class="val-tag" id="val-speed">1.0</span></label>
            <input type="range" id="fireSpeed" min="0.2" max="3.0" step="0.1" value="1.0">
        </div>

        <div class="control-group">
            <label>音量 / Volume <span class="val-tag" id="val-vol">0</span></label>
            <input type="range" id="audioVol" min="0" max="100" value="0">
        </div>

        <div class="control-group">
            <label>声音速率 / Audio Speed <span class="val-tag" id="val-aspeed">1.0</span></label>
            <input type="range" id="audioSpeed" min="0.1" max="2.0" step="0.1" value="1.0">
        </div>

        <div class="divider"></div>

        <div class="control-group">
            <label>字符集 / Charset</label>
            <select id="charSet">
                <option value="ascii">经典 / ASCII</option>
                <option value="binary">二进制 / Binary</option>
                <option value="blocks">方块 / Blocks</option>
                <option value="braille">盲文 / Braille</option>
                <option value="dots">点阵 / Dots</option>
                <option value="japanese">日文 / Kanji</option>
                <option value="matrix">矩阵 / Matrix</option>
            </select>
        </div>

        <div class="control-group">
            <label>字符大小 / Font Size <span class="val-tag" id="val-font">12</span></label>
            <input type="range" id="fontSize" min="6" max="24" value="12">
        </div>

        <div class="control-group">
            <label>视觉缩放 / View Scale <span class="val-tag" id="val-scale">1.0</span></label>
            <input type="range" id="viewScale" min="0.5" max="2.0" step="0.1" value="1.0">
        </div>

        <div class="divider"></div>

        <div class="control-group" style="margin-top:8px; gap: 10px;">
            <button onclick="randomizeFlame()">随机形态 / Randomize</button>
            <button id="exportGif" class="secondary">导出 GIF / Export</button>
        </div>

        <div id="status">系统就绪 / Ready</div>
    </div>

    <button id="ui-toggle">◂</button>

    <div id="main-view">
        <div id="canvas-wrapper">
            <canvas id="fireCanvas"></canvas>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('fireCanvas');
        const wrapper = document.getElementById('canvas-wrapper');
        const panel = document.getElementById('ui-panel');
        const toggleBtn = document.getElementById('ui-toggle');
        const ctx = canvas.getContext('2d', { alpha: false });
        
        // UI 状态控制
        toggleBtn.onclick = () => {
            const isCollapsed = panel.classList.toggle('collapsed');
            toggleBtn.innerText = isCollapsed ? '▸' : '◂';
        };

        const fontSizeInput = document.getElementById('fontSize');
        const viewScaleInput = document.getElementById('viewScale');
        const speedInput = document.getElementById('fireSpeed');
        const volInput = document.getElementById('audioVol');
        const audioSpeedInput = document.getElementById('audioSpeed');
        const widthInput = document.getElementById('canvasWidth');
        const heightInput = document.getElementById('canvasHeight');
        const charSetSelect = document.getElementById('charSet');
        const themeSelect = document.getElementById('uiTheme');
        const presetSelect = document.getElementById('colorPresets');
        const statusText = document.getElementById('status');
        const cBot = document.getElementById('colorBottom'), cMid = document.getElementById('colorMid'), cTop = document.getElementById('colorTop');

        let fontSize = 12, cols, rows, fireData = [], sparks = [];
        let wind = 0, flameHeight = 12, chaosLevel = 0.6, isDrawing = false;
        let lastTime = 0, speed = 1.0, audioSpeed = 1.0;

        let audioCtx, mainGain, lpFilter, hissFilter;

        const charSets = {
            ascii: ['@', '#', '$', '*', '!', ';', ':', '.', ' '],
            binary: ['1', '0', ' '],
            blocks: ['█', '▓', '▒', '░', ' '],
            braille: ['⣿', '⣶', '⣤', '⣀', ' '],
            dots: ['●', '○', '•', '·', ' '],
            japanese: ['火', '炎', '熱', '炭', ' '],
            matrix: ['$', 'シ', '1', '0', ' ']
        };

        const palettes = {
            classic: { top: "#FF2200", mid: "#FF8800", bot: "#FFFFFF" },
            soul: { top: "#0033FF", mid: "#00FFFF", bot: "#EEFFFF" },
            forest: { top: "#006622", mid: "#33FF77", bot: "#CCFFDD" },
            cyber: { top: "#FF00FF", mid: "#5500FF", bot: "#CCFFFF" },
            toxic: { top: "#44FF00", mid: "#FFFF00", bot: "#FFFFFF" },
            void: { top: "#333333", mid: "#666666", bot: "#AAAAAA" },
            sunset: { top: "#660066", mid: "#FF4400", bot: "#FFCC00" },
            ocean: { top: "#000066", mid: "#0044AA", bot: "#FFFFFF" },
            gold: { top: "#884400", mid: "#CC9900", bot: "#FFFFAA" },
            sakura: { top: "#FF66AA", mid: "#FFBBDD", bot: "#FFFFFF" }
        };

        function initCanvas() {
            fontSize = parseInt(fontSizeInput.value);
            canvas.width = parseInt(widthInput.value);
            canvas.height = parseInt(heightInput.value);
            document.getElementById('val-font').innerText = fontSize;
            document.getElementById('val-width').innerText = canvas.width;
            document.getElementById('val-height').innerText = canvas.height;
            cols = Math.floor(canvas.width / (fontSize * 0.75));
            rows = Math.floor(canvas.height / fontSize);
            fireData = new Array(cols * rows).fill(0);
        }

        function updateUIEffects() {
            document.body.classList.toggle('light-mode', themeSelect.value === 'light');
            document.getElementById('val-speed').innerText = speedInput.value;
            document.getElementById('val-vol').innerText = volInput.value;
            document.getElementById('val-aspeed').innerText = audioSpeedInput.value;
            document.getElementById('val-scale').innerText = viewScaleInput.value;
            wrapper.style.transform = `scale(${viewScaleInput.value})`;
            
            speed = parseFloat(speedInput.value);
            audioSpeed = parseFloat(audioSpeedInput.value);
            if (mainGain) {
                mainGain.gain.setTargetAtTime(parseInt(volInput.value) / 100, audioCtx.currentTime, 0.1);
            }
        }

        presetSelect.onchange = function() {
            const p = palettes[this.value];
            if (p) {
                cTop.value = p.top; cMid.value = p.mid; cBot.value = p.bot;
                updateUIEffects();
            }
        };

        function randomizeFireColors() {
            presetSelect.value = "custom";
            const h = Math.random() * 360;
            const hslToHex = (h, s, l) => {
                l /= 100;
                const a = s * Math.min(l, 1 - l) / 100;
                const f = n => {
                    const k = (n + h / 30) % 12;
                    const color = l - a * Math.max(Math.min(k - 3, 9 - k, 1), -1);
                    return Math.round(255 * color).toString(16).padStart(2, '0');
                };
                return `#${f(0)}${f(8)}${f(4)}`;
            };
            cBot.value = hslToHex(h, 100, 85);
            cMid.value = hslToHex((h + 20) % 360, 90, 60);
            cTop.value = hslToHex((h + 40) % 360, 80, 35);
            updateUIEffects();
        }

        function initAudio() {
            if (audioCtx) return;
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            mainGain = audioCtx.createGain();
            mainGain.gain.value = 0;
            const bufferSize = 4096;
            let brownLastOut = 0;
            const node = audioCtx.createScriptProcessor(bufferSize, 1, 1);
            node.onaudioprocess = (e) => {
                let output = e.outputBuffer.getChannelData(0);
                for (let i = 0; i < bufferSize; i++) {
                    let white = Math.random() * 2 - 1;
                    brownLastOut = (brownLastOut + (0.02 * audioSpeed * white)) / 1.02;
                    let hiss = (Math.random() * 2 - 1) * 0.1;
                    output[i] = (brownLastOut * 2.5) + hiss;
                }
            };
            lpFilter = audioCtx.createBiquadFilter();
            lpFilter.type = 'lowpass'; lpFilter.frequency.value = 400;
            hissFilter = audioCtx.createBiquadFilter();
            hissFilter.type = 'highpass'; hissFilter.frequency.value = 2500;
            const hissGain = audioCtx.createGain();
            hissGain.gain.value = 0.2;
            node.connect(lpFilter); node.connect(hissFilter);
            hissFilter.connect(hissGain); lpFilter.connect(mainGain); hissGain.connect(mainGain);
            mainGain.connect(audioCtx.destination);
        }

        function playPop() {
            if(!audioCtx || volInput.value == 0) return;
            const bufferSize = audioCtx.sampleRate * 0.05;
            const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
            const data = buffer.getChannelData(0);
            for (let i = 0; i < bufferSize; i++) {
                data[i] = (Math.random() * 2 - 1) * Math.exp(-i / (bufferSize / 4));
            }
            const source = audioCtx.createBufferSource();
            source.buffer = buffer;
            const filter = audioCtx.createBiquadFilter();
            filter.type = 'bandpass';
            filter.frequency.value = 800 + Math.random() * 1200;
            const g = audioCtx.createGain();
            g.gain.value = (0.5 + Math.random() * 0.8) * (volInput.value/100);
            source.connect(filter); filter.connect(g); g.connect(audioCtx.destination);
            source.start();
        }

        function randomizeFlame() {
            flameHeight = 7 + Math.random() * 16;
            chaosLevel = 0.4 + Math.random() * 1.6;
            wind = (Math.random() - 0.5) * 5;
        }

        function createSpark() {
            if (Math.random() > (0.1 * speed)) return; 
            sparks.push({
                x: Math.random() * canvas.width, y: canvas.height - 20,
                vx: (Math.random() - 0.5) * 4 + wind, vy: -Math.random() * 5 - 2,
                life: 1.0, decay: (0.01 + Math.random() * 0.02) * speed
            });
            if(Math.random() > (0.8 / audioSpeed)) playPop();
        }

        function updateSparks() {
            for (let i = sparks.length - 1; i >= 0; i--) {
                let s = sparks[i];
                s.x += s.vx * speed; s.y += s.vy * speed; s.life -= s.decay;
                if (s.life <= 0 || s.y < 0) sparks.splice(i, 1);
            }
        }

        function updateFire() {
            for (let x = 0; x < cols; x++) fireData[(rows - 1) * cols + x] = Math.random() > 0.6 ? 255 : 0;
            for (let y = 0; y < rows - 1; y++) {
                for (let x = 0; x < cols; x++) {
                    const idx = y * cols + x, src = ((y + 1) * cols + x);
                    const drift = Math.round(wind + (Math.random() - 0.5) * chaosLevel * 4);
                    let tx = (x + drift + cols) % cols;
                    const val = fireData[src] - (Math.random() * flameHeight);
                    fireData[y * cols + tx] = val > 0 ? val : 0;
                }
            }
            createSpark(); updateSparks();
            if(audioCtx && lpFilter) {
                const dynamicFreq = (100 + (flameHeight * 15) + (speed * 80)) * audioSpeed;
                lpFilter.frequency.setTargetAtTime(dynamicFreq, audioCtx.currentTime, 0.2);
            }
            if(Math.random() > (0.985 / audioSpeed)) playPop(); 
        }

        function draw() {
            ctx.fillStyle = '#000'; ctx.fillRect(0, 0, canvas.width, canvas.height);
            const chars = charSets[charSetSelect.value];
            ctx.font = `bold ${fontSize}px monospace`;
            for (let y = 0; y < rows; y++) {
                for (let x = 0; x < cols; x++) {
                    const val = fireData[y * cols + x];
                    if (val > 15) {
                        const cIdx = Math.floor((val / 255) * (chars.length - 1));
                        if (val > 204) ctx.fillStyle = cBot.value;
                        else if (val > 76) ctx.fillStyle = cMid.value;
                        else ctx.fillStyle = cTop.value;
                        ctx.fillText(chars[chars.length - 1 - cIdx], x * fontSize * 0.75, y * fontSize);
                    }
                }
            }
            sparks.forEach(s => {
                ctx.globalAlpha = s.life; ctx.fillStyle = cMid.value;
                ctx.fillText("*", s.x, s.y);
            });
            ctx.globalAlpha = 1.0;
        }

        function handleInput(e) {
            initAudio(); if (audioCtx && audioCtx.state === 'suspended') audioCtx.resume();
            const rect = canvas.getBoundingClientRect();
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            const x = Math.floor((clientX - rect.left) / (fontSize * 0.75));
            const y = Math.floor((clientY - rect.top) / fontSize);
            for(let i=-2; i<=2; i++){
                for(let j=-2; j<=2; j++){
                    const idx = (y+j) * cols + (x+i);
                    if(fireData[idx] !== undefined) fireData[idx] = 255;
                }
            }
        }

        fontSizeInput.addEventListener('input', initCanvas);
        widthInput.addEventListener('input', initCanvas);
        heightInput.addEventListener('input', initCanvas);
        [speedInput, volInput, audioSpeedInput, themeSelect, viewScaleInput, cBot, cMid, cTop].forEach(el => el.addEventListener('input', updateUIEffects));

        canvas.addEventListener('mousedown', (e) => { isDrawing = true; handleInput(e); });
        window.addEventListener('mouseup', () => isDrawing = false);
        canvas.addEventListener('mousemove', (e) => isDrawing && handleInput(e));
        canvas.addEventListener('touchstart', (e) => { isDrawing = true; handleInput(e); });
        canvas.addEventListener('touchend', () => isDrawing = false);
        canvas.addEventListener('touchmove', (e) => { if(isDrawing){ e.preventDefault(); handleInput(e); }}, {passive: false});

        document.getElementById('exportGif').onclick = function() {
            if (typeof GIF === 'undefined') { statusText.innerText = "Error: Library Missing"; return; }
            function createInlineWorker() {
                const workerCode = `(function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require=="function"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}var i=typeof require=="function"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s})({1:[function(require,module,exports){var NeuQuant=require("./TypedNeuQuant.js");var LZWEncoder=require("./LZWEncoder.js");function ByteArray(){this.page=-1;this.pages=[];this.newPage()}ByteArray.pageSize=4096;ByteArray.charMap={};for(var i=0;i<256;i++)ByteArray.charMap[i]=String.fromCharCode(i);ByteArray.prototype.newPage=function(){this.pages[++this.page]=new Uint8Array(ByteArray.pageSize);this.cursor=0};ByteArray.prototype.getData=function(){var rv="";for(var p=0;p<this.pages.length;p++){for(var i=0;i<ByteArray.pageSize;i++){rv+=ByteArray.charMap[this.pages[p][i]]}}return rv};ByteArray.prototype.writeByte=function(val){if(this.cursor>=ByteArray.pageSize)this.newPage();this.pages[this.page][this.cursor++]=val};ByteArray.prototype.writeUTFBytes=function(string){for(var l=string.length,i=0;i<l;i++)this.writeByte(string.charCodeAt(i))};ByteArray.prototype.writeBytes=function(array,offset,length){for(var l=length||array.length,i=offset||0;i<l;i++)this.writeByte(array[i])};function GIFEncoder(width,height){this.width=~~width;this.height=~~height;this.transparent=null;this.transIndex=0;this.repeat=-1;this.delay=0;this.image=null;this.pixels=null;this.indexedPixels=null;this.colorDepth=null;this.colorTab=null;this.neuQuant=null;this.usedEntry=new Array;this.palSize=7;this.dispose=-1;this.firstFrame=true;this.sample=10;this.dither=false;this.globalPalette=false;this.out=new ByteArray}GIFEncoder.prototype.setDelay=function(milliseconds){this.delay=Math.round(milliseconds/10)};GIFEncoder.prototype.setFrameRate=function(fps){this.delay=Math.round(100/fps)};GIFEncoder.prototype.setDispose=function(disposalCode){if(disposalCode>=0)this.dispose=disposalCode};GIFEncoder.prototype.setRepeat=function(repeat){this.repeat=repeat};GIFEncoder.prototype.setTransparent=function(color){this.transparent=color};GIFEncoder.prototype.addFrame=function(imageData){this.image=imageData;this.colorTab=this.globalPalette&&this.globalPalette.slice?this.globalPalette:null;this.getImagePixels();this.analyzePixels();if(this.globalPalette===true)this.globalPalette=this.colorTab;if(this.firstFrame){this.writeLSD();this.writePalette();if(this.repeat>=0){this.writeNetscapeExt()}}this.writeGraphicCtrlExt();this.writeImageDesc();if(!this.firstFrame&&!this.globalPalette)this.writePalette();this.writePixels();this.firstFrame=false};GIFEncoder.prototype.finish=function(){this.out.writeByte(59)};GIFEncoder.prototype.setQuality=function(quality){if(quality<1)quality=1;this.sample=quality};GIFEncoder.prototype.setDither=function(dither){if(dither===true)dither="FloydSteinberg";this.dither=dither};GIFEncoder.prototype.setGlobalPalette=function(palette){this.globalPalette=palette};GIFEncoder.prototype.getGlobalPalette=function(){return this.globalPalette&&this.globalPalette.slice&&this.globalPalette.slice(0)||this.globalPalette};GIFEncoder.prototype.writeHeader=function(){this.out.writeUTFBytes("GIF89a")};GIFEncoder.prototype.analyzePixels=function(){if(!this.colorTab){this.neuQuant=new NeuQuant(this.pixels,this.sample);this.neuQuant.buildColormap();this.colorTab=this.neuQuant.getColormap()}if(this.dither){this.ditherPixels(this.dither.replace("-serpentine",""),this.dither.match(/-serpentine/)!==null)}else{this.indexPixels()}this.pixels=null;this.colorDepth=8;this.palSize=7;if(this.transparent!==null){this.transIndex=this.findClosest(this.transparent,true)}};GIFEncoder.prototype.indexPixels=function(imgq){var nPix=this.pixels.length/3;this.indexedPixels=new Uint8Array(nPix);var k=0;for(var j=0;j<nPix;j++){var index=this.findClosestRGB(this.pixels[k++]&255,this.pixels[k++]&255,this.pixels[k++]&255);this.usedEntry[index]=true;this.indexedPixels[j]=index}};GIFEncoder.prototype.ditherPixels=function(kernel,serpentine){var kernels={FalseFloydSteinberg:[[3/8,1,0],[3/8,0,1],[2/8,1,1]],FloydSteinberg:[[7/16,1,0],[3/16,-1,1],[5/16,0,1],[1/16,1,1]],Stucki:[[8/42,1,0],[4/42,2,0],[2/42,-2,1],[4/42,-1,1],[8/42,0,1],[4/42,1,1],[2/42,2,1],[1/42,-2,2],[2/42,-1,2],[4/42,0,2],[2/42,1,2],[1/42,2,2]],Atkinson:[[1/8,1,0],[1/8,2,0],[1/8,-1,1],[1/8,0,1],[1/8,1,1],[1/8,0,2]]};if(!kernel||!kernels[kernel]){throw"Unknown dithering kernel: "+kernel}var ds=kernels[kernel];var index=0,height=this.height,width=this.width,data=this.pixels;var direction=serpentine?-1:1;this.indexedPixels=new Uint8Array(this.pixels.length/3);for(var y=0;y<height;y++){if(serpentine)direction=direction*-1;for(var x=direction==1?0:width-1,xend=direction==1?width:0;x+=direction){index=y*width+x;var idx=index*3;var r1=data[idx];var g1=data[idx+1];var b1=data[idx+2];idx=this.findClosestRGB(r1,g1,b1);this.usedEntry[idx]=true;this.indexedPixels[index]=idx;idx*=3;var r2=this.colorTab[idx];var g2=this.colorTab[idx+1];var b2=this.colorTab[idx+2];var er=r1-r2;var eg=g1-g2;var eb=b1-b2;for(var i=direction==1?0:ds.length-1,end=direction==1?ds.length:0;i+=direction){var x1=ds[i][1];var y1=ds[i][2];if(x1+x>=0&&x1+x<width&&y1+y>=0&&y1+y<height){var d=ds[i][0];idx=index+x1+y1*width;idx*=3;data[idx]=Math.max(0,Math.min(255,data[idx]+er*d));data[idx+1]=Math.max(0,Math.min(255,data[idx+1]+eg*d));data[idx+2]=Math.max(0,Math.min(255,data[idx+2]+eb*d))}}}}};GIFEncoder.prototype.findClosest=function(c,used){return this.findClosestRGB((c&16711680)>>16,(c&65280)>>8,c&255,used)};GIFEncoder.prototype.findClosestRGB=function(r,g,b,used){if(this.colorTab===null)return-1;if(this.neuQuant&&!used){return this.neuQuant.lookupRGB(r,g,b)}var c=b|g<<8|r<<16;var minpos=0;var dmin=256*256*256;var len=this.colorTab.length;for(var i=0,index=0;i<len;index++){var dr=r-(this.colorTab[i++]&255);var dg=g-(this.colorTab[i++]&255);var db=b-(this.colorTab[i++]&255);var d=dr*dr+dg*dg+db*db;if((!used||this.usedEntry[index])&&d<dmin){dmin=d;minpos=index}}return minpos};GIFEncoder.prototype.getImagePixels=function(){var w=this.width;var h=this.height;this.pixels=new Uint8Array(w*h*3);var data=this.image;var srcPos=0;var count=0;for(var i=0;i<h;i++){for(var j=0;j<w;j++){this.pixels[count++]=data[srcPos++];this.pixels[count++]=data[srcPos++];this.pixels[count++]=data[srcPos++];srcPos++}}};GIFEncoder.prototype.writeGraphicCtrlExt=function(){this.out.writeByte(33);this.out.writeByte(249);this.out.writeByte(4);var transp,disp;if(this.transparent===null){transp=0;disp=0}else{transp=1;disp=2}if(this.dispose>=0){disp=dispose&7}disp<<=2;this.out.writeByte(0|disp|0|transp);this.writeShort(this.delay);this.out.writeByte(this.transIndex);this.out.writeByte(0)};GIFEncoder.prototype.writeImageDesc=function(){this.out.writeByte(44);this.writeShort(0);this.writeShort(0);this.writeShort(this.width);this.writeShort(this.height);if(this.firstFrame||this.globalPalette){this.out.writeByte(0)}else{this.out.writeByte(128|0|0|0|this.palSize)}};GIFEncoder.prototype.writeLSD=function(){this.writeShort(this.width);this.writeShort(this.height);this.out.writeByte(128|112|0|this.palSize);this.out.writeByte(0);this.out.writeByte(0)};GIFEncoder.prototype.writeNetscapeExt=function(){this.out.writeByte(33);this.out.writeByte(255);this.out.writeByte(11);this.out.writeUTFBytes("NETSCAPE2.0");this.out.writeByte(3);this.out.writeByte(1);this.writeShort(this.repeat);this.out.writeByte(0)};GIFEncoder.prototype.writePalette=function(){this.out.writeBytes(this.colorTab);var n=3*256-this.colorTab.length;for(var i=0;i<n;i++)this.out.writeByte(0)};GIFEncoder.prototype.writeShort=function(pValue){this.out.writeByte(pValue&255);this.out.writeByte(pValue>>8&255)};GIFEncoder.prototype.writePixels=function(){var enc=new LZWEncoder(this.width,this.height,this.indexedPixels,this.colorDepth);enc.encode(this.out)};GIFEncoder.prototype.stream=function(){return this.out};module.exports=GIFEncoder},{"./LZWEncoder.js":2,"./TypedNeuQuant.js":3}],2:[function(require,module,exports){var EOF=-1;var BITS=12;var HSIZE=5003;var masks=[0,1,3,7,15,31,63,127,255,511,1023,2047,4095,8191,16383,32767,65535];function LZWEncoder(width,height,pixels,colorDepth){var initCodeSize=Math.max(2,colorDepth);var accum=new Uint8Array(256);var htab=new Int32Array(HSIZE);var codetab=new Int32Array(HSIZE);var cur_accum,cur_bits=0;var a_count;var free_ent=0;var maxcode;var clear_flg=false;var g_init_bits,ClearCode,EOFCode;function char_out(c,outs){accum[a_count++]=c;if(a_count>=254)flush_char(outs)}function cl_block(outs){cl_hash(HSIZE);free_ent=ClearCode+2;clear_flg=true;output(ClearCode,outs)}function cl_hash(hsize){for(var i=0;i<hsize;++i)htab[i]=-1}function compress(init_bits,outs){var fcode,c,i,ent,disp,hsize_reg,hshift;g_init_bits=init_bits;clear_flg=false;n_bits=g_init_bits;maxcode=MAXCODE(n_bits);ClearCode=1<<init_bits-1;EOFCode=ClearCode+1;free_ent=ClearCode+2;a_count=0;ent=nextPixel();hshift=0;for(fcode=HSIZE;fcode<65536;fcode*=2)++hshift;hshift=8-hshift;hsize_reg=HSIZE;cl_hash(hsize_reg);output(ClearCode,outs);outer_loop:while((c=nextPixel())!=EOF){fcode=(c<<BITS)+ent;i=c<<hshift^ent;if(htab[i]===fcode){ent=codetab[i];continue}else if(htab[i]>=0){disp=hsize_reg-i;if(i===0)disp=1;do{if((i-=disp)<0)i+=hsize_reg;if(htab[i]===fcode){ent=codetab[i];continue outer_loop}}while(htab[i]>=0)}output(ent,outs);ent=c;if(free_ent<1<<BITS){codetab[i]=free_ent++;htab[i]=fcode}else{cl_block(outs)}}output(ent,outs);output(EOFCode,outs)}function encode(outs){outs.writeByte(initCodeSize);remaining=width*height;curPixel=0;compress(initCodeSize+1,outs);outs.writeByte(0)}function flush_char(outs){if(a_count>0){outs.writeByte(a_count);outs.writeBytes(accum,0,a_count);a_count=0}}function MAXCODE(n_bits){return(1<<n_bits)-1}function nextPixel(){if(remaining===0)return EOF;--remaining;var pix=pixels[curPixel++];return pix&255}function output(code,outs){cur_accum&=masks[cur_bits];if(cur_bits>0)cur_accum|=code<<cur_bits;else cur_accum=code;cur_bits+=n_bits;while(cur_bits>=8){char_out(cur_accum&255,outs);cur_accum>>=8;cur_bits-=8}if(free_ent>maxcode||clear_flg){if(clear_flg){maxcode=MAXCODE(n_bits=g_init_bits);clear_flg=false}else{++n_bits;if(n_bits==BITS)maxcode=1<<BITS;else maxcode=MAXCODE(n_bits)}}if(code==EOFCode){while(cur_bits>0){char_out(cur_accum&255,outs);cur_accum>>=8;cur_bits-=8}flush_char(outs)}}this.encode=encode}module.exports=LZWEncoder},{}],3:[function(require,module,exports){var ncycles=100;var netsize=256;var maxnetpos=netsize-1;var netbiasshift=4;var intbiasshift=16;var intbias=1<<intbiasshift;var gammashift=10;var gamma=1<<gammashift;var betashift=10;var beta=intbias>>betashift;var betagamma=intbias<<gammashift-betashift;var initrad=netsize>>3;var radiusbiasshift=6;var radiusbias=1<<radiusbiasshift;var initradius=initrad*radiusbias;var radiusdec=30;var alphabiasshift=10;var initalpha=1<<alphabiasshift;var alphadec;var radbiasshift=8;var radbias=1<<radbiasshift;var alpharadbshift=alphabiasshift+radbiasshift;var alpharadbias=1<<alpharadbshift;var prime1=499;var prime2=491;var prime3=487;var prime4=503;var minpicturebytes=3*prime4;function NeuQuant(pixels,samplefac){var network;var netindex;var bias;var freq;var radpower;function init(){network=[];netindex=new Int32Array(256);bias=new Int32Array(netsize);freq=new Int32Array(netsize);radpower=new Int32Array(netsize>>3);var i,v;for(i=0;i<netsize;i++){v=(i<<netbiasshift+8)/netsize;network[i]=new Float64Array([v,v,v,0]);freq[i]=intbias/netsize;bias[i]=0}}function unbiasnet(){for(var i=0;i<netsize;i++){network[i][0]>>=netbiasshift;network[i][1]>>=netbiasshift;network[i][2]>>=netbiasshift;network[i][3]=i}}function altersingle(alpha,i,b,g,r){network[i][0]-=alpha*(network[i][0]-b)/initalpha;network[i][1]-=alpha*(network[i][1]-g)/initalpha;network[i][2]-=alpha*(network[i][2]-r)/initalpha}function alterneigh(radius,i,b,g,r){var lo=Math.abs(i-radius);var hi=Math.min(i+radius,netsize);var j=i+1;var k=i-1;var m=1;var p,a;while(j<hi||k>lo){a=radpower[m++];if(j<hi){p=network[j++];p[0]-=a*(p[0]-b)/alpharadbias;p[1]-=a*(p[1]-g)/alpharadbias;p[2]-=a*(p[2]-r)/alpharadbias}if(k>lo){p=network[k--];p[0]-=a*(p[0]-b)/alpharadbias;p[1]-=a*(p[1]-g)/alpharadbias;p[2]-=a*(p[2]-r)/alpharadbias}}}function contest(b,g,r){var bestd=~(1<<31);var bestbiasd=bestd;var bestpos=-1;var bestbiaspos=bestpos;var i,n,dist,biasdist,betafreq;for(i=0;i<netsize;i++){n=network[i];dist=Math.abs(n[0]-b)+Math.abs(n[1]-g)+Math.abs(n[2]-r);if(dist<bestd){bestd=dist;bestpos=i}biasdist=dist-(bias[i]>>intbiasshift-netbiasshift);if(biasdist<bestbiasd){bestbiasd=biasdist;bestbiaspos=i}betafreq=freq[i]>>betashift;freq[i]-=betafreq;bias[i]+=betafreq<<gammashift}freq[bestpos]+=beta;bias[bestpos]-=betagamma;return bestbiaspos}function inxbuild(){var i,j,p,q,smallpos,smallval,previouscol=0,startpos=0;for(i=0;i<netsize;i++){p=network[i];smallpos=i;smallval=p[1];for(j=i+1;j<netsize;j++){q=network[j];if(q[1]<smallval){smallpos=j;smallval=q[1]}}q=network[smallpos];if(i!=smallpos){j=q[0];q[0]=p[0];p[0]=j;j=q[1];q[1]=p[1];p[1]=j;j=q[2];q[2]=p[2];p[2]=j;j=q[3];q[3]=p[3];p[3]=j}if(smallval!=previouscol){netindex[previouscol]=startpos+i>>1;for(j=previouscol+1;j<smallval;j++)netindex[j]=i;previouscol=smallval;startpos=i}}netindex[previouscol]=startpos+maxnetpos>>1;for(j=previouscol+1;j<256;j++)netindex[j]=maxnetpos}function inxsearch(b,g,r){var a,p,dist;var bestd=1e3;var best=-1;var i=netindex[g];var j=i-1;while(i<netsize||j>=0){if(i<netsize){p=network[i];dist=p[1]-g;if(dist>=bestd)i=netsize;else{i++;if(dist<0)dist=-dist;a=p[0]-b;if(a<0)a=-a;dist+=a;if(dist<bestd){a=p[2]-r;if(a<0)a=-a;dist+=a;if(dist<bestd){bestd=dist;best=p[3]}}}}if(j>=0){p=network[j];dist=g-p[1];if(dist>=bestd)j=-1;else{j--;if(dist<0)dist=-dist;a=p[0]-b;if(a<0)a=-a;dist+=a;if(dist<bestd){a=p[2]-r;if(a<0)a=-a;dist+=a;if(dist<bestd){bestd=dist;best=p[3]}}}}}return best}function learn(){var i;var lengthcount=pixels.length;var alphadec=30+(samplefac-1)/3;var samplepixels=lengthcount/(3*samplefac);var delta=~~(samplepixels/ncycles);var alpha=initalpha;var radius=initradius;var rad=radius>>radiusbiasshift;if(rad<=1)rad=0;for(i=0;i<rad;i++)radpower[i]=alpha*((rad*rad-i*i)*radbias/(rad*rad));var step;if(lengthcount<minpicturebytes){samplefac=1;step=3}else if(lengthcount%prime1!==0){step=3*prime1}else if(lengthcount%prime2!==0){step=3*prime2}else if(lengthcount%prime3!==0){step=3*prime3}else{step=3*prime4}var b,g,r,j;var pix=0;i=0;while(i<samplepixels){b=(pixels[pix]&255)<<netbiasshift;g=(pixels[pix+1]&255)<<netbiasshift;r=(pixels[pix+2]&255)<<netbiasshift;j=contest(b,g,r);altersingle(alpha,j,b,g,r);if(rad!==0)alterneigh(rad,j,b,g,r);pix+=step;if(pix>=lengthcount)pix-=lengthcount;i++;if(delta===0)delta=1;if(i%delta===0){alpha-=alpha/alphadec;radius-=radius/radiusdec;rad=radius>>radiusbiasshift;if(rad<=1)rad=0;for(j=0;j<rad;j++)radpower[j]=alpha*((rad*rad-j*j)*radbias/(rad*rad))}}}function buildColormap(){init();learn();unbiasnet();inxbuild()}this.buildColormap=buildColormap;function getColormap(){var map=[];var index=[];for(var i=0;i<netsize;i++)index[network[i][3]]=i;var k=0;for(var l=0;l<netsize;l++){var j=index[l];map[k++]=network[j][0];map[k++]=network[j][1];map[k++]=network[j][2]}return map}this.getColormap=getColormap;this.lookupRGB=inxsearch}module.exports=NeuQuant},{}],4:[function(require,module,exports){var GIFEncoder,renderFrame;GIFEncoder=require("./GIFEncoder.js");renderFrame=function(frame){var encoder,page,stream,transfer;encoder=new GIFEncoder(frame.width,frame.height);if(frame.index===0){encoder.writeHeader()}else{encoder.firstFrame=false}encoder.setTransparent(frame.transparent);encoder.setRepeat(frame.repeat);encoder.setDelay(frame.delay);encoder.setQuality(frame.quality);encoder.setDither(frame.dither);encoder.setGlobalPalette(frame.globalPalette);encoder.addFrame(frame.data);if(frame.last){encoder.finish()}if(frame.globalPalette===true){frame.globalPalette=encoder.getGlobalPalette()}stream=encoder.stream();frame.data=stream.pages;frame.cursor=stream.cursor;frame.pageSize=stream.constructor.pageSize;if(frame.canTransfer){transfer=function(){var i,len,ref,results;ref=frame.data;results=[];for(i=0,len=ref.length;i<len;i++){page=ref[i];results.push(page.buffer)}return results}();return self.postMessage(frame,transfer)}else{return self.postMessage(frame)}};self.onmessage=function(event){return renderFrame(event.data)}},{"./GIFEncoder.js":1}]},{},[4]);`;
                const blob = new Blob([workerCode], { type: 'application/javascript' });
                return URL.createObjectURL(blob);
            }
            try {
                const gif = new GIF({ workers: 2, quality: 10, width: canvas.width, height: canvas.height, workerScript: createInlineWorker() });
                let count = 0; statusText.innerText = "Recording / 录制中...";
                const timer = setInterval(() => {
                    updateFire(); draw(); gif.addFrame(canvas, {copy: true, delay: 50});
                    statusText.innerText = `REC: ${Math.round((++count/60)*100)}%`;
                    if (count >= 60) {
                        clearInterval(timer);
                        gif.on('finished', (blob) => {
                            const url = URL.createObjectURL(blob); const a = document.createElement('a');
                            a.href = url; a.download = 'fire_' + Date.now() + '.gif';
                            a.click(); URL.revokeObjectURL(url); statusText.innerText = "Success / 导出成功";
                        });
                        gif.render();
                    }
                }, 50);
            } catch (e) { statusText.innerText = "Fail / 失败: " + e.message; }
        };

        function loop(timestamp) {
            const dt = timestamp - lastTime;
            const interval = 1000 / (30 * speed); 
            if (dt > interval) {
                updateFire(); draw(); lastTime = timestamp;
            }
            requestAnimationFrame(loop);
        }

        initCanvas();
        updateUIEffects();
        requestAnimationFrame(loop);
    </script>
</body>
</html>
    
  </body>
  
</html>
