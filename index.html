<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Pixel Bonfire - Mobile Optimized Edition</title>
    <script src="https://cdn.jsdelivr.net/npm/gif.js@0.2.0/dist/gif.js"></script>
    <style>
        :root { 
            --bg: #000000; 
            --panel-bg: rgba(29, 29, 31, 0.95);
            --text-main: #f5f5f7;
            --text-secondary: #86868b;
            --accent: #ffffff;
            --danger: #ff3b30;
            --border-color: rgba(255, 255, 255, 0.1);
            --panel-width: 280px;
            --strip-width: 44px; /* 移动端适配：略微加宽竖条以便手指点击 */
            --control-bg: rgba(255, 255, 255, 0.08);
            --toggle-bg: rgba(255, 255, 255, 0.15);
        }

        body.light-mode {
            --bg: #ffffff;
            --panel-bg: rgba(245, 245, 247, 0.95);
            --text-main: #1d1d1f;
            --text-secondary: #6e6e73;
            --accent: #000000;
            --border-color: rgba(0, 0, 0, 0.08);
            --control-bg: rgba(0, 0, 0, 0.05);
            --toggle-bg: rgba(0, 0, 0, 0.1);
        }

        * { 
            box-sizing: border-box; 
            -webkit-tap-highlight-color: transparent; /* 移除移动端点击高亮 */
        }

        body {
            background-color: var(--bg); color: var(--text-main);
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", Helvetica, Arial, sans-serif;
            margin: 0; display: flex; flex-direction: row;
            height: 100vh; overflow: hidden; touch-action: none;
            transition: background-color 0.3s ease;
            -webkit-touch-callout: none; /* 屏蔽长按弹出菜单 */
            -webkit-user-select: none;
            user-select: none;
        }

        #sidebar-wrapper {
            display: flex;
            height: 100vh;
            z-index: 2000;
            transition: margin-left 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            flex-shrink: 0;
        }
        #sidebar-wrapper.collapsed {
            margin-left: calc(var(--panel-width) * -1);
        }

        #ui-panel {
            width: var(--panel-width);
            background: var(--panel-bg);
            border-right: 1px solid var(--border-color);
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            overflow-y: auto;
            backdrop-filter: blur(20px);
            -webkit-app-region: no-drag;
        }

        #ui-panel::-webkit-scrollbar { width: 4px; background: transparent; }
        #ui-panel::-webkit-scrollbar-thumb { background: rgba(128,128,128,0.3); border-radius: 10px; }

        #action-strip {
            width: var(--strip-width);
            background: var(--panel-bg);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: env(safe-area-inset-top, 15px) 0;
            gap: 20px;
            backdrop-filter: blur(20px);
            -webkit-app-region: no-drag;
        }

        .win-btn {
            width: 32px; height: 32px;
            display: flex; align-items: center; justify-content: center;
            border-radius: 50%; border: none; cursor: pointer;
            background: var(--control-bg); color: var(--text-main);
            transition: all 0.2s; font-size: 12px;
        }
        .btn-close:hover { background: var(--danger); color: white; }

        #ui-toggle {
            width: 32px; height: 32px;
            border-radius: 50%;
            background: var(--control-bg);
            border: 1px solid var(--border-color);
            cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            color: var(--text-secondary);
            transition: all 0.2s;
        }
        #ui-toggle::after { 
            content: '▲'; font-size: 10px; transition: transform 0.4s;
            transform: rotate(-90deg);
        }
        #sidebar-wrapper.collapsed #ui-toggle::after { transform: rotate(90deg); }

        h3 { margin: 0; font-size: 16px; font-weight: 600; opacity: 0.8; }

        #main-view {
            -webkit-app-region: drag;
            flex: 1;
            display: flex; align-items: center; justify-content: center;
            background: var(--bg); overflow: hidden; position: relative;
            touch-action: none; /* 禁止原生滚动 */
        }

        .control-group { display: flex; flex-direction: column; gap: 6px; }
        label { font-size: 10px; font-weight: 500; color: var(--text-secondary); text-transform: uppercase; }
        
        .val-input {
            float: right; background: transparent; border: none;
            color: var(--text-secondary); font-size: 10px; font-weight: 600;
            text-align: right; width: 45px; outline: none; padding: 0; font-family: inherit;
        }

        #canvas-wrapper { 
            -webkit-app-region: no-drag; 
            position: relative; 
            line-height: 0; 
            transition: transform 0.2s ease;
            touch-action: none;
        }
        canvas { 
            image-rendering: pixelated; 
            cursor: crosshair; 
            background: #000; 
            border-radius: 4px; 
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            max-width: 95vw; /* 移动端适配：防止画布溢出 */
            max-height: 90vh;
        }

        button {
            background: var(--control-bg); color: var(--text-main); border: 1px solid var(--border-color);
            padding: 12px; border-radius: 8px; font-size: 12px; font-weight: 500; cursor: pointer; transition: all 0.2s;
        }
        
        select {
            background: var(--control-bg); color: var(--text-main);
            border: 1px solid var(--border-color); padding: 10px; border-radius: 8px; font-size: 12px;
            outline: none; appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='grey' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat; background-position: right 8px center; background-size: 12px;
            padding-right: 28px;
        }
        select option { background-color: #1d1d1f; color: #f5f5f7; }

        input[type="text"].custom-chars { background: var(--control-bg); color: var(--text-main); border: 1px solid var(--border-color); padding: 10px; border-radius: 8px; font-size: 12px; outline: none; }
        input[type="color"] { -webkit-appearance: none; border: none; width: 100%; height: 28px; cursor: pointer; background: none; padding: 0; border-radius: 4px; }
        input[type="range"] { -webkit-appearance: none; width: 100%; height: 4px; background: var(--control-bg); border-radius: 2px; accent-color: var(--accent); }

        .divider { height: 1px; background: var(--border-color); margin: 4px 0; }
        #status { font-size: 9px; color: var(--text-secondary); text-align: center; margin-top: auto; opacity: 0.6; padding-bottom: env(safe-area-inset-bottom, 0); }
    </style>
</head>
<body>

    <div id="sidebar-wrapper">
        <div id="ui-panel">
            <h3>Bonfire</h3>
            
            <div class="control-group">
                <label>UI 风格 / Theme</label>
                <select id="uiTheme">
                    <option value="dark">暗黑 / Dark</option>
                    <option value="light">明亮 / Light</option>
                </select>
            </div>

            <div class="divider"></div>

            <div class="control-group">
                <label>预设 / Presets</label>
                <select id="colorPresets">
                    <option value="custom">自定义 / Custom</option>
                    <option value="classic">经典 / Classic</option>
                    <option value="soul">灵魂 / Soul</option>
                    <option value="forest">森 / Forest</option>
                    <option value="cyber">赛博 / Cyber</option>
                    <option value="toxic">剧毒 / Toxic</option>
                    <option value="void">虚空 / Void</option>
                    <option value="sunset">落日 / Sunset</option>
                    <option value="ocean">深海 / Ocean</option>
                    <option value="gold">黄金 / Gold</option>
                    <option value="sakura">樱花 / Sakura</option>
                </select>
            </div>

            <div class="control-group"><label>顶部 / Top</label><input type="color" id="colorTop" value="#ff2200"></div>
            <div class="control-group"><label>中部 / Mid</label><input type="color" id="colorMid" value="#ff8800"></div>
            <div class="control-group"><label>底部 / Bottom</label><input type="color" id="colorBottom" value="#ffffff"></div>
            <button onclick="randomizeFireColors()">随机配色 / Randomize</button>

            <div class="divider"></div>

            <div class="control-group">
                <label>宽度 / Width <input type="number" id="val-width" class="val-input" title="Max: 1000"></label>
                <input type="range" id="canvasWidth" min="200" max="1000" value="400">
            </div>
            <div class="control-group">
                <label>高度 / Height <input type="number" id="val-height" class="val-input" title="Max: 1000"></label>
                <input type="range" id="canvasHeight" min="200" max="1000" value="500">
            </div>

            <div class="divider"></div>

            <div class="control-group">
                <label>字符集 / Charset</label>
                <select id="charSet">
                    <option value="ascii">经典 / ASCII</option>
                    <option value="binary">二进制 / Binary</option>
                    <option value="blocks">方块 / Blocks</option>
                    <option value="braille">盲文 / Braille</option>
                    <option value="dots">点阵 / Dots</option>
                    <option value="japanese">日文 / Kanji</option>
                    <option value="matrix">矩阵 / Matrix</option>
                    <option value="customChar">自定义 / Custom</option>
                </select>
            </div>
            <div class="control-group" id="customCharGroup" style="display:none">
                <label>输入字符 / Input String</label>
                <input type="text" id="customInput" class="custom-chars" value="@#$*!">
            </div>
            <div class="control-group">
                <label>字号 / Size <input type="number" id="val-font" class="val-input" title="Max: 24"></label>
                <input type="range" id="fontSize" min="6" max="24" value="12">
            </div>
            <div class="control-group">
                <label>缩放 / Scale <input type="number" id="val-scale" class="val-input" step="0.1" title="Max: 2.0"></label>
                <input type="range" id="viewScale" min="0.5" max="2.0" step="0.1" value="1.0">
            </div>

            <div class="divider"></div>

            <div class="control-group">
                <label>燃烧速度 / Speed <input type="number" id="val-speed" class="val-input" step="0.1" title="Max: 3.0"></label>
                <input type="range" id="fireSpeed" min="0.2" max="3.0" step="0.1" value="1.0">
            </div>
            <div class="control-group">
                <label>声音场景 / Audio Scene</label>
                <select id="audioScene">
                    <option value="bonfire">自然篝火 / Bonfire</option>
                    <option value="charcoal">煤炭燃烧 / Charcoal</option>
                    <option value="fireplace">室内壁炉 / Fireplace</option>
                    <option value="twig">干燥枯枝 / Twigs</option>
                </select>
            </div>
            <div class="control-group">
                <label>音量 / Volume <input type="number" id="val-vol" class="val-input" title="Max: 100"></label>
                <input type="range" id="audioVol" min="0" max="100" value="0">
            </div>

            <div class="divider"></div>
            <div class="control-group" style="margin-top:8px; gap: 8px;">
                <button onclick="randomizeFlame()">随机形态 / Randomize</button>
                <button id="exportGif">导出 GIF / Export</button>
            </div>
            <div id="status">Ready</div>
        </div>

        <div id="action-strip">
            <button class="win-btn btn-close" id="btn-close" title="退出">✕</button>
            <button class="win-btn" id="btn-fs" title="全屏">⤢</button>
            <div style="flex: 1;"></div>
            <div id="ui-toggle" title="展开/收起侧边栏"></div>
        </div>
    </div>

    <div id="main-view">
        <div id="canvas-wrapper">
            <canvas id="fireCanvas"></canvas>
        </div>
    </div>

    <script>
        let win;
        try {
            win = nw.Window.get();
            document.getElementById('btn-close').onclick = () => win.close();
            document.getElementById('btn-fs').onclick = () => win.toggleFullscreen();
        } catch(e) {}

        const canvas = document.getElementById('fireCanvas'), wrapper = document.getElementById('canvas-wrapper'), sidebarWrapper = document.getElementById('sidebar-wrapper'), toggleBtn = document.getElementById('ui-toggle'), ctx = canvas.getContext('2d', { alpha: false });
        
        toggleBtn.addEventListener('click', () => {
            sidebarWrapper.classList.toggle('collapsed');
        });

        const fontSizeInput = document.getElementById('fontSize'), viewScaleInput = document.getElementById('viewScale'), speedInput = document.getElementById('fireSpeed'), volInput = document.getElementById('audioVol'), widthInput = document.getElementById('canvasWidth'), heightInput = document.getElementById('canvasHeight'), charSetSelect = document.getElementById('charSet'), themeSelect = document.getElementById('uiTheme'), presetSelect = document.getElementById('colorPresets'), audioSceneSelect = document.getElementById('audioScene'), statusText = document.getElementById('status'), cBot = document.getElementById('colorBottom'), cMid = document.getElementById('colorMid'), cTop = document.getElementById('colorTop'), customInput = document.getElementById('customInput'), customCharGroup = document.getElementById('customCharGroup');

        const valWidth = document.getElementById('val-width'), valHeight = document.getElementById('val-height'), valFont = document.getElementById('val-font'), valSpeed = document.getElementById('val-speed'), valVol = document.getElementById('val-vol'), valScale = document.getElementById('val-scale');

        function syncInput(rangeEl, inputEl, callback) {
            inputEl.value = rangeEl.value;
            rangeEl.oninput = () => { inputEl.value = rangeEl.value; callback(); };
            inputEl.onchange = () => { rangeEl.value = inputEl.value; callback(); };
        }

        let fontSize = 12, cols, rows, fireData = [], sparks = [], wind = 0, flameHeight = 12, chaosLevel = 0.6, lastTime = 0, speed = 1.0;
        let audioCtx, mainGain, lpFilter;

        const charSets = { 
            ascii: ['@', '#', '$', '*', '!', ';', ':', '.', ' '], 
            binary: ['1', '0', ' '], 
            blocks: ['█', '▓', '▒', '░', ' '], 
            braille: ['⣿', '⣶', '⣤', '⣀', ' '], 
            dots: ['●', '○', '•', '·', ' '], 
            japanese: ['火', '炎', '熱', '炭', ' '], 
            matrix: ['$', 'シ', '1', '0', ' '] 
        };

        const sceneConfig = {
            bonfire: { lpf: 400, popFreq: 1200, popChance: 0.1, popVol: 0.8, noiseVol: 1.0 },
            charcoal: { lpf: 300, popFreq: 1500, popChance: 0.15, popVol: 1.0, noiseVol: 0.01 },
            fireplace: { lpf: 200, popFreq: 800, popChance: 0.05, popVol: 1.2, noiseVol: 0.8 },
            twig: { lpf: 800, popFreq: 2200, popChance: 0.2, popVol: 0.4, noiseVol: 1.2 }
        };

        charSetSelect.onchange = () => { customCharGroup.style.display = charSetSelect.value === 'customChar' ? 'flex' : 'none'; };

        function initCanvas() {
            fontSize = parseInt(fontSizeInput.value); 
            canvas.width = parseInt(widthInput.value); 
            canvas.height = parseInt(heightInput.value);
            cols = Math.floor(canvas.width / (fontSize * 0.75)); 
            rows = Math.floor(canvas.height / fontSize); 
            fireData = new Array(cols * rows).fill(0);
        }

        function updateUIEffects() {
            document.body.classList.toggle('light-mode', themeSelect.value === 'light');
            wrapper.style.transform = `scale(${viewScaleInput.value})`;
            speed = parseFloat(speedInput.value);
            if (mainGain) mainGain.gain.setTargetAtTime(parseInt(volInput.value) / 100, audioCtx.currentTime, 0.1);
        }

        presetSelect.onchange = function() { const p = palettes[this.value]; if (p) { cTop.value = p.top; cMid.value = p.mid; cBot.value = p.bot; updateUIEffects(); } };
        const palettes = { classic: { top: "#FF2200", mid: "#FF8800", bot: "#FFFFFF" }, soul: { top: "#0033FF", mid: "#00FFFF", bot: "#EEFFFF" }, forest: { top: "#006622", mid: "#33FF77", bot: "#CCFFDD" }, cyber: { top: "#FF00FF", mid: "#5500FF", bot: "#CCFFFF" }, toxic: { top: "#44FF00", mid: "#FFFF00", bot: "#FFFFFF" }, void: { top: "#333333", mid: "#666666", bot: "#AAAAAA" }, sunset: { top: "#660066", mid: "#FF4400", bot: "#FFCC00" }, ocean: { top: "#000066", mid: "#0044AA", bot: "#FFFFFF" }, gold: { top: "#884400", mid: "#CC9900", bot: "#FFFFAA" }, sakura: { top: "#FF66AA", mid: "#FFBBDD", bot: "#FFFFFF" } };

        function randomizeFireColors() {
            presetSelect.value = "custom"; const h = Math.random() * 360;
            const hslToHex = (h, s, l) => { l /= 100; const a = s * Math.min(l, 1 - l) / 100; const f = n => { const k = (n + h / 30) % 12; const color = l - a * Math.max(Math.min(k - 3, 9 - k, 1), -1); return Math.round(255 * color).toString(16).padStart(2, '0'); }; return `#${f(0)}${f(8)}${f(4)}`; };
            cBot.value = hslToHex(h, 100, 85); cMid.value = hslToHex((h + 20) % 360, 90, 60); cTop.value = hslToHex((h + 40) % 360, 80, 35); updateUIEffects();
        }

        function initAudio() {
            if (audioCtx) return; audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            mainGain = audioCtx.createGain(); mainGain.gain.value = 0;
            const bufferSize = 4096; let brownLastOut = 0;
            const node = audioCtx.createScriptProcessor(bufferSize, 1, 1);
            node.onaudioprocess = (e) => {
                let output = e.outputBuffer.getChannelData(0);
                const scene = sceneConfig[audioSceneSelect.value] || sceneConfig.bonfire;
                for (let i = 0; i < bufferSize; i++) {
                    let white = Math.random() * 2 - 1; brownLastOut = (brownLastOut + (0.02 * white)) / 1.02;
                    output[i] = ((brownLastOut * 2.5) + (Math.random() * 2 - 1) * 0.1) * scene.noiseVol;
                }
            };
            lpFilter = audioCtx.createBiquadFilter(); lpFilter.type = 'lowpass'; lpFilter.frequency.value = 400;
            node.connect(lpFilter); lpFilter.connect(mainGain); mainGain.connect(audioCtx.destination);
        }

        function playPop() {
            if(!audioCtx || volInput.value == 0) return;
            const scene = sceneConfig[audioSceneSelect.value] || sceneConfig.bonfire;
            const bufferSize = audioCtx.sampleRate * 0.05, buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate), data = buffer.getChannelData(0);
            for (let i = 0; i < bufferSize; i++) data[i] = (Math.random() * 2 - 1) * Math.exp(-i / (bufferSize / 4));
            const source = audioCtx.createBufferSource(); source.buffer = buffer;
            const filter = audioCtx.createBiquadFilter(); filter.type = 'bandpass'; 
            filter.frequency.value = scene.popFreq + (Math.random() - 0.5) * 500;
            const g = audioCtx.createGain(); g.gain.value = (0.5 + Math.random() * scene.popVol) * (volInput.value/100);
            source.connect(filter); filter.connect(g); g.connect(audioCtx.destination); source.start();
        }

        function randomizeFlame() { flameHeight = 7 + Math.random() * 16; chaosLevel = 0.4 + Math.random() * 1.6; wind = (Math.random() - 0.5) * 5; }
        function createSpark() {
            if (Math.random() > (0.1 * speed)) return; 
            sparks.push({ x: Math.random() * canvas.width, y: canvas.height - 20, vx: (Math.random() - 0.5) * 4 + wind, vy: -Math.random() * 5 - 2, life: 1.0, decay: (0.01 + Math.random() * 0.02) * speed });
            const scene = sceneConfig[audioSceneSelect.value] || sceneConfig.bonfire;
            if(Math.random() < scene.popChance) playPop();
        }
        function updateSparks() { for (let i = sparks.length - 1; i >= 0; i--) { let s = sparks[i]; s.x += s.vx * speed; s.y += s.vy * speed; s.life -= s.decay; if (s.life <= 0 || s.y < 0) sparks.splice(i, 1); } }
        function updateFire() {
            for (let x = 0; x < cols; x++) fireData[(rows - 1) * cols + x] = Math.random() > 0.6 ? 255 : 0;
            for (let y = 0; y < rows - 1; y++) { for (let x = 0; x < cols; x++) { const idx = y * cols + x, src = ((y + 1) * cols + x); const drift = Math.round(wind + (Math.random() - 0.5) * chaosLevel * 4); let tx = (x + drift + cols) % cols; const val = fireData[src] - (Math.random() * flameHeight); fireData[y * cols + tx] = val > 0 ? val : 0; } }
            createSpark(); updateSparks();
        }

        function draw() {
            ctx.fillStyle = '#000'; ctx.fillRect(0, 0, canvas.width, canvas.height);
            let chars = charSetSelect.value === 'customChar' ? customInput.value.split('') : charSets[charSetSelect.value];
            if (!chars || chars.length === 0) chars = [' '];
            ctx.font = `bold ${fontSize}px monospace`;
            for (let y = 0; y < rows; y++) { for (let x = 0; x < cols; x++) { const val = fireData[y * cols + x]; if (val > 15) { if (val > 204) ctx.fillStyle = cBot.value; else if (val > 76) ctx.fillStyle = cMid.value; else ctx.fillStyle = cTop.value; ctx.fillText(chars[chars.length - 1 - Math.floor((val / 255) * (chars.length - 1))], x * fontSize * 0.75, y * fontSize); } } }
            sparks.forEach(s => { ctx.globalAlpha = s.life; ctx.fillStyle = cMid.value; ctx.fillText("*", s.x, s.y); });
            ctx.globalAlpha = 1.0;
        }

        function handleInput(e) {
            initAudio(); if (audioCtx && audioCtx.state === 'suspended') audioCtx.resume();
            const rect = canvas.getBoundingClientRect();
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            
            // 计算逻辑：支持缩放和移动端坐标映射
            const x = Math.floor(((clientX - rect.left) / rect.width * canvas.width) / (fontSize * 0.75));
            const y = Math.floor(((clientY - rect.top) / rect.height * canvas.height) / fontSize);
            for(let i=-2; i<=2; i++){ for(let j=-2; j<=2; j++){ const idx = (y+j) * cols + (x+i); if(fireData[idx] !== undefined) fireData[idx] = 255; } }
        }

        window.onload = () => {
            syncInput(widthInput, valWidth, initCanvas); syncInput(heightInput, valHeight, initCanvas); syncInput(fontSizeInput, valFont, initCanvas);
            syncInput(speedInput, valSpeed, updateUIEffects); syncInput(volInput, valVol, updateUIEffects); syncInput(viewScaleInput, valScale, updateUIEffects);
            initCanvas(); updateUIEffects();
            function loop(timestamp) { if (timestamp - lastTime > 1000 / (30 * speed)) { updateFire(); draw(); lastTime = timestamp; } requestAnimationFrame(loop); }
            requestAnimationFrame(loop);
        };

        // 移动端点火优化：滑动即响应
        canvas.addEventListener('mousemove', handleInput);
        canvas.addEventListener('touchstart', (e) => { 
            handleInput(e); 
        }, {passive:false});
        canvas.addEventListener('touchmove', (e) => { 
            e.preventDefault(); // 阻止移动端页面滚动
            handleInput(e); 
        }, {passive:false});
        
        document.getElementById('exportGif').onclick = function() {
            statusText.innerText = "Processing...";
        };
    </script>
</body>
</html>